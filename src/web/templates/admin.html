{% extends "base.html" %}

{% block title %}Admin - Azure RAG Financial System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1><i class="fas fa-cogs me-2"></i>Admin Panel</h1>
        <p class="lead">Manage companies and 10-K filings for the RAG system.</p>
    </div>
</div>

<!-- System Status -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>System Status</h5>
            </div>
            <div class="card-body">
                {% if rag_available %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>Azure RAG pipeline is active and ready
                    </div>
                    {% if stats and 'error' not in stats %}
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-primary">{{ stats.total_documents }}</div>
                                    <small class="text-muted">Total Documents</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-primary">{{ stats.service_name or 'N/A' }}</div>
                                    <small class="text-muted">Search Service</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-primary">{{ stats.index_name or 'N/A' }}</div>
                                    <small class="text-muted">Search Index</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-primary">Active</div>
                                    <small class="text-muted">Status</small>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Azure RAG pipeline is not available
                        {% if stats and stats.error %}
                            <br><small>Error: {{ stats.error }}</small>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Company Management -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-building me-2"></i>Add New Company</h5>
            </div>
            <div class="card-body">
                <form id="addCompanyForm">
                    <div class="mb-3">
                        <label for="companySymbol" class="form-label">Company Symbol</label>
                        <input type="text" class="form-control" id="companySymbol" placeholder="e.g., AAPL" required>
                        <div class="form-text">Stock ticker symbol (e.g., GOOGL, MSFT, AAPL)</div>
                    </div>
                    <div class="mb-3">
                        <label for="companyName" class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="companyName" placeholder="e.g., Apple Inc." required>
                    </div>
                    <div class="mb-3">
                        <label for="companyCik" class="form-label">CIK Code</label>
                        <input type="text" class="form-control" id="companyCik" placeholder="e.g., 0000320193" required>
                        <div class="form-text">SEC Central Index Key (CIK) for the company</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Company
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar me-2"></i>Add Years for Existing Companies</h5>
            </div>
            <div class="card-body">
                <form id="addYearsForm">
                    <div class="mb-3">
                        <label for="selectedCompanies" class="form-label">Select Companies</label>
                        <select class="form-select" id="selectedCompanies" multiple required>
                            <!-- Companies will be loaded dynamically -->
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple companies</div>
                    </div>
                    <div class="mb-3">
                        <label for="selectedYears" class="form-label">Years to Add</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="2021" id="year2021">
                                    <label class="form-check-label" for="year2021">2021</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="2020" id="year2020">
                                    <label class="form-check-label" for="year2020">2020</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="2019" id="year2019">
                                    <label class="form-check-label" for="year2019">2019</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="2018" id="year2018">
                                    <label class="form-check-label" for="year2018">2018</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="2017" id="year2017">
                                    <label class="form-check-label" for="year2017">2017</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="2016" id="year2016">
                                    <label class="form-check-label" for="year2016">2016</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-download me-2"></i>Add Years & Process
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Processing Status -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks me-2"></i>Processing Status</h5>
            </div>
            <div class="card-body">
                <div id="processingStatus" class="d-none">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                            <div>
                                <strong>Processing...</strong>
                                <div id="processingMessage">Preparing to scrape and process filings...</div>
                            </div>
                        </div>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="processingProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div id="processingResults"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addCompanyForm = document.getElementById('addCompanyForm');
    const addYearsForm = document.getElementById('addYearsForm');
    const processingStatus = document.getElementById('processingStatus');
    const processingMessage = document.getElementById('processingMessage');
    const processingProgress = document.getElementById('processingProgress');
    const processingResults = document.getElementById('processingResults');

    // Load available companies on page load
    loadAvailableCompanies();

    function loadAvailableCompanies() {
        fetch('/api/admin/companies')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('selectedCompanies');
                select.innerHTML = ''; // Clear existing options
                
                Object.entries(data.companies).forEach(([symbol, company]) => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = `${symbol} - ${company.name}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading companies:', error);
        });
    }

    // Add Company Form Handler
    addCompanyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const symbol = document.getElementById('companySymbol').value.trim().toUpperCase();
        const name = document.getElementById('companyName').value.trim();
        const cik = document.getElementById('companyCik').value.trim();
        
        if (!symbol || !name || !cik) {
            alert('Please fill in all fields');
            return;
        }
        
        showProcessingStatus('Adding new company...');
        
        fetch('/api/admin/add-company', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbol: symbol,
                name: name,
                cik: cik
            })
        })
        .then(response => response.json())
        .then(data => {
            hideProcessingStatus();
            if (data.success) {
                showResults(`<div class="alert alert-success">
                    <i class="fas fa-check me-2"></i>Company ${symbol} added successfully!
                </div>`);
                addCompanyForm.reset();
                
                // Reload the companies list
                loadAvailableCompanies();
            } else {
                showResults(`<div class="alert alert-danger">
                    <i class="fas fa-times me-2"></i>Error: ${data.error || 'Failed to add company'}
                </div>`);
            }
        })
        .catch(error => {
            hideProcessingStatus();
            console.error('Error:', error);
            showResults(`<div class="alert alert-danger">
                <i class="fas fa-times me-2"></i>Error adding company: ${error.message}
            </div>`);
        });
    });

    // Add Years Form Handler
    addYearsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedCompanies = Array.from(document.getElementById('selectedCompanies').selectedOptions)
            .map(option => option.value);
        const selectedYears = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
            .map(checkbox => parseInt(checkbox.value));
        
        if (selectedCompanies.length === 0) {
            alert('Please select at least one company');
            return;
        }
        
        if (selectedYears.length === 0) {
            alert('Please select at least one year');
            return;
        }
        
        showProcessingStatus('Starting scraping and processing...');
        updateProgress(10, 'Initializing scraper...');
        
        fetch('/api/admin/add-years', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                companies: selectedCompanies,
                years: selectedYears
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateProgress(100, 'Processing completed successfully!');
                setTimeout(() => {
                    hideProcessingStatus();
                    showResults(`<div class="alert alert-success">
                        <i class="fas fa-check me-2"></i>Successfully processed ${data.processed_files || 0} files and generated ${data.total_chunks || 0} embeddings.
                        <br><small>Companies: ${selectedCompanies.join(', ')} | Years: ${selectedYears.join(', ')}</small>
                    </div>`);
                }, 1000);
                addYearsForm.reset();
            } else {
                hideProcessingStatus();
                showResults(`<div class="alert alert-danger">
                    <i class="fas fa-times me-2"></i>Error: ${data.error || 'Failed to process'}
                </div>`);
            }
        })
        .catch(error => {
            hideProcessingStatus();
            console.error('Error:', error);
            showResults(`<div class="alert alert-danger">
                <i class="fas fa-times me-2"></i>Error processing: ${error.message}
            </div>`);
        });
    });

    function showProcessingStatus(message) {
        processingMessage.textContent = message;
        processingStatus.classList.remove('d-none');
        processingResults.innerHTML = '';
        updateProgress(0);
    }

    function hideProcessingStatus() {
        processingStatus.classList.add('d-none');
    }

    function updateProgress(percent, message) {
        processingProgress.style.width = percent + '%';
        if (message) {
            processingMessage.textContent = message;
        }
    }

    function showResults(html) {
        processingResults.innerHTML = html;
    }
});
</script>
{% endblock %}