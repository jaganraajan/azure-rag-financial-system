{% extends "base.html" %}

{% block title %}Admin - Azure RAG Financial System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1><i class="fas fa-cogs me-2"></i>Admin Panel</h1>
        <p class="lead">Manage companies and 10-K filings for the RAG system.</p>
    </div>
</div>

<!-- System Status -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>System Status</h5>
            </div>
            <div class="card-body">
                {% if rag_available %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>Azure RAG pipeline is active and ready
                    </div>
                    {% if stats and 'error' not in stats %}
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-primary">{{ stats.total_documents }}</div>
                                    <small class="text-muted">Total Documents</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-primary">{{ stats.service_name or 'N/A' }}</div>
                                    <small class="text-muted">Search Service</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-primary">{{ stats.index_name or 'N/A' }}</div>
                                    <small class="text-muted">Search Index</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-primary">Active</div>
                                    <small class="text-muted">Status</small>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Azure RAG pipeline is not available
                        {% if stats and stats.error %}
                            <br><small>Error: {{ stats.error }}</small>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- File Management -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cloud me-2"></i>Azure Storage File Management</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6>Files in Azure Blob Storage</h6>
                            <small class="text-muted">Select files to create vector embeddings or manage stored 10-K filings</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-primary btn-sm" onclick="refreshFileList()">
                                <i class="fas fa-sync me-1"></i>Refresh Files
                            </button>
                        </div>
                    </div>
                    
                    <div id="fileListContainer">
                        <div class="d-flex justify-content-center p-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading files...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-info" onclick="createEmbeddingsForSelected()" disabled id="createEmbeddingsBtn">
                        <i class="fas fa-vector-square me-2"></i>Create Embeddings for Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
 // File management functions
window.refreshFileList = function() {
    const container = document.getElementById('fileListContainer');
    container.innerHTML = `
        <div class="d-flex justify-content-center p-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading files...</span>
            </div>
        </div>
    `;

    fetch('/api/admin/storage-files')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayFileList(data.files, data.container);
        } else {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || 'Failed to load files from Azure Storage'}
                    <br><small>Make sure Azure Storage connection is configured properly</small>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading files:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times me-2"></i>Error loading files: ${error.message}
            </div>
        `;
    });
}

// Make displayFileList globally available
window.displayFileList = function(files, containerName) {
    const container = document.getElementById('fileListContainer');
    
    if (files.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No files found in Azure Storage container "${containerName}". 
                <br>Use the scraper to download 10-K filings first.
            </div>
        `;
        return;
    }

    let html = `
        <div class="row mb-3">
            <div class="col">
                <h6>Container: <span class="text-primary">${containerName}</span> (${files.length} files)</h6>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th width="50">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllFiles(this)">
                        </th>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Last Modified</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    files.forEach(file => {
        const sizeKB = (file.size / 1024).toFixed(1);
        const lastModified = file.last_modified 
            ? new Date(file.last_modified).toLocaleDateString() 
            : 'Unknown';
        
        html += `
            <tr>
                <td>
                    <input type="checkbox" class="file-checkbox" value="${file.name}" 
                           onchange="updateEmbeddingsButton()">
                </td>
                <td>
                    <i class="fas fa-file-alt me-1 text-primary"></i>
                    ${file.name}
                </td>
                <td>${sizeKB} KB</td>
                <td>${lastModified}</td>
                <td>
                    <a href="${file.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt me-1"></i>View
                    </a>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
};

window.updateEmbeddingsButton = function() {
    // Always reference the button from the DOM
    const createEmbeddingsBtn = document.getElementById('createEmbeddingsBtn');
    const checkedBoxes = document.querySelectorAll('.file-checkbox:checked');
    if (createEmbeddingsBtn) {
        createEmbeddingsBtn.disabled = checkedBoxes.length === 0;
        const text = checkedBoxes.length === 0 
            ? 'Create Embeddings for Selected'
            : `Create Embeddings (${checkedBoxes.length} selected)`;
        createEmbeddingsBtn.innerHTML = `<i class="fas fa-vector-square me-2"></i>${text}`;
    }
}

window.createEmbeddingsForSelected = function() {
    const checkedBoxes = document.querySelectorAll('.file-checkbox:checked');
    const selectedFiles = Array.from(checkedBoxes).map(cb => cb.value);
    if (selectedFiles.length === 0) {
        alert('Please select at least one file to create embeddings');
        return;
    }
    showProcessingStatus('Creating vector embeddings...');
    updateProgress(10, `Processing ${selectedFiles.length} selected files...`);
    fetch('/api/admin/create-embeddings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            files: selectedFiles
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateProgress(100, 'Vector embeddings created successfully!');
            setTimeout(() => {
                hideProcessingStatus();
                showResults(`<div class="alert alert-success">
                    <i class="fas fa-check me-2"></i>Successfully created embeddings for ${data.processed_files} files.
                    <br><small>Generated ${data.total_chunks} text chunks and ${data.search_documents} search documents</small>
                    <br><strong>Files processed:</strong> ${selectedFiles.join(', ')}
                </div>`);
                deselectAllFiles();
            }, 1000);
        } else {
            hideProcessingStatus();
            showResults(`<div class="alert alert-danger">
                <i class="fas fa-times me-2"></i>Error: ${data.error || 'Failed to create embeddings'}
            </div>`);
        }
    })
    .catch(error => {
        hideProcessingStatus();
        console.error('Error:', error);
        showResults(`<div class="alert alert-danger">
            <i class="fas fa-times me-2"></i>Error creating embeddings: ${error.message}
        </div>`);
    });
}

window.showProcessingStatus = function(message) {
    const statusDiv = document.getElementById('processingStatus');
    if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `<div class="alert alert-info">${message}</div>`;
    }
};

window.hideProcessingStatus = function() {
    const statusDiv = document.getElementById('processingStatus');
    if (statusDiv) {
        statusDiv.style.display = 'none';
        statusDiv.innerHTML = '';
    }
};

window.updateProgress = function(percent, message) {
    const statusDiv = document.getElementById('processingStatus');
    if (statusDiv) {
        statusDiv.innerHTML = `
            <div class="progress mb-2">
                <div class="progress-bar" role="progressbar" style="width: ${percent}%;">
                    ${percent}%
                </div>
            </div>
            <div>${message}</div>
        `;
    }
};

window.showResults = function(html) {
    const resultsDiv = document.getElementById('resultsContainer');
    if (resultsDiv) {
        resultsDiv.innerHTML = html;
    }
};

window.deselectAllFiles = function() {
    document.querySelectorAll('.file-checkbox:checked').forEach(cb => cb.checked = false);
    window.updateEmbeddingsButton();
};

document.addEventListener('DOMContentLoaded', function() {
    const addCompanyForm = document.getElementById('addCompanyForm');
    const addYearsForm = document.getElementById('addYearsForm');
    const processingStatus = document.getElementById('processingStatus');
    const processingMessage = document.getElementById('processingMessage');
    const processingProgress = document.getElementById('processingProgress');
    const processingResults = document.getElementById('processingResults');
    const createEmbeddingsBtn = document.getElementById('createEmbeddingsBtn');

    // Load available companies and files on page load
    loadAvailableCompanies();
    refreshFileList();

    function loadAvailableCompanies() {
        fetch('/api/admin/companies')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('selectedCompanies');
                select.innerHTML = ''; // Clear existing options
                
                Object.entries(data.companies).forEach(([symbol, company]) => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = `${symbol} - ${company.name}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading companies:', error);
        });
    }

    // Add Company Form Handler
    addCompanyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const symbol = document.getElementById('companySymbol').value.trim().toUpperCase();
        const name = document.getElementById('companyName').value.trim();
        const cik = document.getElementById('companyCik').value.trim();
        
        if (!symbol || !name || !cik) {
            alert('Please fill in all fields');
            return;
        }
        
        showProcessingStatus('Adding new company...');
        
        fetch('/api/admin/add-company', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbol: symbol,
                name: name,
                cik: cik
            })
        })
        .then(response => response.json())
        .then(data => {
            hideProcessingStatus();
            if (data.success) {
                showResults(`<div class="alert alert-success">
                    <i class="fas fa-check me-2"></i>Company ${symbol} added successfully!
                </div>`);
                addCompanyForm.reset();
                
                // Reload the companies list
                loadAvailableCompanies();
            } else {
                showResults(`<div class="alert alert-danger">
                    <i class="fas fa-times me-2"></i>Error: ${data.error || 'Failed to add company'}
                </div>`);
            }
        })
        .catch(error => {
            hideProcessingStatus();
            console.error('Error:', error);
            showResults(`<div class="alert alert-danger">
                <i class="fas fa-times me-2"></i>Error adding company: ${error.message}
            </div>`);
        });
    });

    // Add Years Form Handler
    addYearsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedCompanies = Array.from(document.getElementById('selectedCompanies').selectedOptions)
            .map(option => option.value);
        const selectedYears = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
            .map(checkbox => parseInt(checkbox.value));
        
        if (selectedCompanies.length === 0) {
            alert('Please select at least one company');
            return;
        }
        
        if (selectedYears.length === 0) {
            alert('Please select at least one year');
            return;
        }
        
        showProcessingStatus('Starting scraping and processing...');
        updateProgress(10, 'Initializing scraper...');
        
        fetch('/api/admin/add-years', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                companies: selectedCompanies,
                years: selectedYears
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateProgress(100, 'Processing completed successfully!');
                setTimeout(() => {
                    hideProcessingStatus();
                    showResults(`<div class="alert alert-success">
                        <i class="fas fa-check me-2"></i>Successfully processed ${data.processed_files || 0} files and generated ${data.total_chunks || 0} embeddings.
                        <br><small>Companies: ${selectedCompanies.join(', ')} | Years: ${selectedYears.join(', ')}</small>
                    </div>`);
                    // Refresh file list after processing
                    refreshFileList();
                }, 1000);
                addYearsForm.reset();
            } else {
                hideProcessingStatus();
                showResults(`<div class="alert alert-danger">
                    <i class="fas fa-times me-2"></i>Error: ${data.error || 'Failed to process'}
                </div>`);
            }
        })
        .catch(error => {
            hideProcessingStatus();
            console.error('Error:', error);
            showResults(`<div class="alert alert-danger">
                <i class="fas fa-times me-2"></i>Error processing: ${error.message}
            </div>`);
        });
    });

    function showProcessingStatus(message) {
        processingMessage.textContent = message;
        processingStatus.classList.remove('d-none');
        processingResults.innerHTML = '';
        updateProgress(0);
    }

    function hideProcessingStatus() {
        processingStatus.classList.add('d-none');
    }

    function updateProgress(percent, message) {
        processingProgress.style.width = percent + '%';
        if (message) {
            processingMessage.textContent = message;
        }
    }

    function showResults(html) {
        processingResults.innerHTML = html;
    }

    // function displayFileList(files, containerName) {
    //     const container = document.getElementById('fileListContainer');
        
    //     if (files.length === 0) {
    //         container.innerHTML = `
    //             <div class="alert alert-info">
    //                 <i class="fas fa-info-circle me-2"></i>
    //                 No files found in Azure Storage container "${containerName}". 
    //                 <br>Use the scraper to download 10-K filings first.
    //             </div>
    //         `;
    //         return;
    //     }

    //     let html = `
    //         <div class="row mb-3">
    //             <div class="col">
    //                 <h6>Container: <span class="text-primary">${containerName}</span> (${files.length} files)</h6>
    //             </div>
    //         </div>
    //         <div class="table-responsive">
    //             <table class="table table-striped table-hover">
    //                 <thead class="table-dark">
    //                     <tr>
    //                         <th width="50">
    //                             <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllFiles(this)">
    //                         </th>
    //                         <th>File Name</th>
    //                         <th>Size</th>
    //                         <th>Last Modified</th>
    //                         <th>Actions</th>
    //                     </tr>
    //                 </thead>
    //                 <tbody>
    //     `;

    //     files.forEach(file => {
    //         const sizeKB = (file.size / 1024).toFixed(1);
    //         const lastModified = file.last_modified 
    //             ? new Date(file.last_modified).toLocaleDateString() 
    //             : 'Unknown';
            
    //         html += `
    //             <tr>
    //                 <td>
    //                     <input type="checkbox" class="file-checkbox" value="${file.name}" 
    //                            onchange="updateEmbeddingsButton()">
    //                 </td>
    //                 <td>
    //                     <i class="fas fa-file-alt me-1 text-primary"></i>
    //                     ${file.name}
    //                 </td>
    //                 <td>${sizeKB} KB</td>
    //                 <td>${lastModified}</td>
    //                 <td>
    //                     <a href="${file.url}" target="_blank" class="btn btn-sm btn-outline-primary">
    //                         <i class="fas fa-external-link-alt me-1"></i>View
    //                     </a>
    //                 </td>
    //             </tr>
    //         `;
    //     });

    //     html += `
    //                 </tbody>
    //             </table>
    //         </div>
    //     `;

    //     container.innerHTML = html;
    // }

    window.selectAllFiles = function() {
        const checkboxes = document.querySelectorAll('.file-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        checkboxes.forEach(cb => cb.checked = true);
        if (selectAllCheckbox) selectAllCheckbox.checked = true;
        updateEmbeddingsButton();
    }

    window.deselectAllFiles = function() {
        const checkboxes = document.querySelectorAll('.file-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        checkboxes.forEach(cb => cb.checked = false);
        if (selectAllCheckbox) selectAllCheckbox.checked = false;
        updateEmbeddingsButton();
    }

    window.toggleAllFiles = function(selectAllCheckbox) {
        const checkboxes = document.querySelectorAll('.file-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
        updateEmbeddingsButton();
    }


    window.triggerScraperJob = function() {
        const selectedCompanies = Array.from(document.getElementById('selectedCompanies').selectedOptions)
            .map(option => option.value);
        const selectedYears = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
            .map(checkbox => parseInt(checkbox.value));
        
        if (selectedCompanies.length === 0) {
            alert('Please select at least one company from the "Add Years for Existing Companies" section');
            return;
        }
        
        if (selectedYears.length === 0) {
            alert('Please select at least one year from the "Add Years for Existing Companies" section');
            return;
        }

        showProcessingStatus('Triggering scraper job...');
        updateProgress(20, 'Starting SEC EDGAR scraper...');

        fetch('/api/admin/trigger-scraper', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                companies: selectedCompanies,
                years: selectedYears
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateProgress(100, 'Scraper job completed successfully!');
                setTimeout(() => {
                    hideProcessingStatus();
                    showResults(`<div class="alert alert-success">
                        <i class="fas fa-check me-2"></i>Successfully scraped ${data.total_files} files to Azure Storage.
                        <br><small>Companies: ${selectedCompanies.join(', ')} | Years: ${selectedYears.join(', ')}</small>
                    </div>`);
                    // Refresh file list after scraping
                    refreshFileList();
                }, 1000);
            } else {
                hideProcessingStatus();
                showResults(`<div class="alert alert-danger">
                    <i class="fas fa-times me-2"></i>Error: ${data.error || 'Failed to run scraper'}
                </div>`);
            }
        })
        .catch(error => {
            hideProcessingStatus();
            console.error('Error:', error);
            showResults(`<div class="alert alert-danger">
                <i class="fas fa-times me-2"></i>Error running scraper: ${error.message}
            </div>`);
        });
    }

});
</script>
{% endblock %}